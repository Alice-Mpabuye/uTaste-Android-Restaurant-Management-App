@startuml

'============
'data classes
'============

package "com.example.utaste.data" {

    class Ingredient {
        - id: int
        - name: String
        - qrCode: String
        - carbohydrates: double
        - fat: double
        - protein: double
        - fiber: double
        - salt: double
        + Ingredient(id: int, name: String, qrCode: String)
        + Ingredient(id: int, name: String, qrCode: String, carbohydrates: double, fat: double, protein: double, fiber: double, salt: double)
        + getId(): int
        + getName(): String
        + getQrCode(): String
        + getCarbohydrates(): double
        + getFat(): double
        + getProtein(): double
        + getFiber(): double
        + getSalt(): double
        + setName(String name): void
        + setId(int id): void
    }

    class Recipe {
        - id: int
        - name: String
        - description: String
        - image: String
        + Recipe(id: int, name: String, description: String, image: String)
        + getId(): int
        + getName(): String
        + getDescription(): String
        + getImage(): String
    }

    class RecipeIngredient {
        - ingredientId: int
        - name: String
        - quantity: double
        - carbs: double
        - protein: double
        - fat: double
        - fiber: double
        - salt: double
        + RecipeIngredient(ingredientId: int, name: String, quantity: double, carbs: double, fat: double, protein: double, fiber: double, salt: double)
        + getIngredientId(): int
        + getName(): String
        + getQuantity(): double
        + setQuantity(quantity: double)
        + getCarbs(): double
        + getProtein(): double
        + getFat(): double
        + getFiber(): double
        + getSalt(): double
    }

    class RecipeRepository {
        - static instance: RecipeRepository
        - dbHelper: UserDbHelper
        - RecipeRepository(context: Context)
        + static synchronized init(context: Context): void
        + getInstance(): RecipeRepository
        + createRecipe(name: String, description: String, imageName: String): long
        + listRecipes(): List<Recipe>
        + getRecipeById(recipeId: int): Recipe
        + updateRecipe(id: int, name: String, description: String, imageName: String): int
        + deleteRecipe(id: int): void
        + addIngredientToRecipe(recipeId: int, ingredientId: int, quantity: double): void
        + getIngredientsForRecipe(recipeId: int): List<RecipeIngredient>
        + insertIngredient(Ingredient ing): long
        + clearIngredientsForRecipe(recipeId: int): void
    }

    class Sale{
        - id: long
        - recipeId: int
        - recipeName: String
        - rating: int
        - note: String
        - timestamp: long
        + Sale(id: long, recipeId: int, recipeName: String, rating: int, note: String, timestamp: long)
        + getId(): long
        + getRecipeId(): int
        + getRecipeName(): String
        + getRating(): int
        + getNote(): String
        + getTimestamp(): long
    }

    class SaleRepository {
        - static instance: SaleRepository
        - dbHelper: UserDbHelper
        - sales: List<Sale>
        - SaleRepository(context: Context)
        + static synchronized init(context: Context): void
        + static synchronized getInstance(): SaleRepository
        + recordSale(recipeId: int, rating: int, note: String): long
        + listAllSales(): List<Sale>
        + listSalesGroupedByRecipe(): Map<Integer, List<Sale>>
        + getCountForRecipe(recipeId: int): int
        + getAverageRatingForRecipe(recipeId: int): double
        + clearAllSales(): void
    }

    class UserDbHelper {
        + UserDbHelper(context: Context)
        + onCreate(db: SQLiteDatabase): void
        + onUpgrade(db: SQLiteDatabase, oldV: int, newV: int): void
        + getIngredientByQRCode(qrCode: String): Ingredient
        + getIngredientByName(name: String): Ingredient
        + addIngredientToRecipe(recipeId: int, ingredientId: int, quantity: double): void
        + getAllRecipes(): List<Recipe>
        + createRecipe(name: String, description: String, imageName: String): long
        + resetDatabase(): void
        + resetUserPassword(email: String): boolean
        + updateIngredientQuantity(int recipeId, int ingredientId, double quantity): void
    }

    class UserRepository {
        - static instance: UserRepository
        - usersByEmail: Map<String, User>
        - context: Context
        - UserRepository(ctx: Context)
        + static synchronized init(context: Context): void
        + static synchronized getInstance(): UserRepository
        - ensureDefaultAccounts(): void
        + addUser(user: User): boolean
        + findByEmail(email: String): User
        + authenticate(email: String, password: String): boolean
        + updateUser(originalEmail: String, updated: User): boolean
        + deleteUser(email: String): boolean
        + listWaiters(): List<User>
        + listAllUsers(): List<User>
        - insertUserInternal(user: User): boolean
        - insertUserInternal(user: User, db: SQLiteDatabase): boolean
        - userToContentValues(u: User): ContentValues
        - cursorToUser(c: Cursor): User
        - findByEmailInternal(email: String): User
        + resetDatabaseToDefaults(): void
    }

    '============ relationships ============
    UserDbHelper -|> SQLiteOpenHelper
    
    RecipeRepository ..> UserDbHelper
    RecipeRepository --> Recipe
    RecipeRepository --> RecipeIngredient
    
    UserRepository --> User

    'SaleRepository --> Sale : fournit des listes de ventes
    'SaleRepository --> Recipe : id de référence
}


'=============
'model classes
'=============

package "com.example.utaste.model" {

    class user{
        + enum Role { ADMIN, CHEF, WAITER }
        - String email
        - String password
        - String firstName
        - String lastName
        - Role role
        - long createdAt
        - long modifiedAt
        + user(String email, String password, Role role)
    
        + String getEmail()
        + void setEmail(String email)
        + String getPassword()
        + void setPassword(String password)
        + String getFirstName()
        + void setFirstName(String firstName)
        + String getLastName()
        + void setLastName(String lastName)
        + Role getRole()
        + void setRole(Role role)
        + long getCreatedAt()
        + void setCreatedAt(long createdAt)
        + long getModifiedAt()
        + void setModifiedAt(long modifiedAt)
        + void touchModified()
        + String toString()
    }
}


'============
'UI classes
'============

package "com.example.utaste.ui" {

    class AdminActivity {
        - Button btnCreateWaiter
        - Button btnResetDB
        - Button btnManageProfiles
        - Button btnLogout
        - Button btnChangePassword
        - Button btnResetSelfPassword

        - ListView waiterListView
        - ArrayAdapter<String> adapter
        - String currentAdminEmail
        - SimpleDateFormat dateFormat
        - ExecutorService executor

        # void onCreate(Bundle savedInstanceState)
        - void refreshWaiterList()
        - void showCreateWaiterDialog()
        - void showWaiterOptionsDialog(User waiter)
        - void confirmAndDeleteWaiter(User waiter)
        - void showEditWaiterDialog(User waiter)
        - void showChangePasswordDialog(String userEmail) 
        - void confirmResetSelfPassword()
        - void performResetSelfPassword()
        - void confirmResetUserPassword(User user)
        - void confirmDatabaseReset()
        - void performDatabaseReset()
        # void onDestroy()
    }

    class CaptureAct {}

    class ChefActivity {
        - Button btnLogout
        - Button btnChangePassword
        - Button btnCreateRecipe
        - Button btnMyRecipes
        - String currentChefEmail
        - UserRepository userRepository

        # void onCreate(Bundle savedInstanceState)
        - void showChangePasswordDialog(String userEmail)
    }

    class CreateRecipeActivity {
        - EditText etName
        - EditText etDescription
        - Spinner spinnerImage
        - Button btnSave
        - Button btnScanIngredient
        - Button btnGoToChefFromCreate
        - ActivityResultLauncher<ScanOptions> barLauncher
        - UserDbHelper dbHelper
        - RecipeRepository recipeRepository
        - RecyclerView rvIngredients
        - List<RecipeIngredient> ingredientList
        - IngredientAdapter adapter
        - long currentRecipeId
        - boolean isEditMode

        # void onCreate(Bundle savedInstanceState)
        - void loadRecipeData()
        - void saveOrUpdateRecipe()
        - void showQuantityDialog(Ingredient ingredient)
        - void scanCode()  
        - void fetchNutritionFromOpenFoodFacts(String barcode, Ingredient ingredient)
    }

    class IngredientAdapter {
        - List<RecipeIngredient> ingredients
        + IngredientAdapter(List<RecipeIngredient> ingredients, Object o)
        + ViewHolder onCreateViewHolder(ViewGroup parent, int viewType)
        + void onBindViewHolder(ViewHolder holder, int position)
        + int getItemCount()
        + void addIngredient(RecipeIngredient ing)
    }

    class IngredientDetailAdapter {
        - context: Context
        - ingredients: List<RecipeIngredient>
        - recipeId: int
        - isCreateMode: boolean
        - readonly: boolean
        + IngredientDetailAdapter()
        + ViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType)
        + void onBindViewHolder(@NonNull ViewHolder holder, int position)
        - showIngredientOptions(int position, RecipeIngredient ingredient): void
        - showQuantityDialog(int position, RecipeIngredient ingredient): void
        - deleteIngredient(int position): void
        - updateIngredientsInRepo(): void
        + int getItemCount()
    }

    class ViewHolder {
        + TextView text1
        + TextView text2
        + ViewHolder(View itemView)
    }

    class LoginActivity {
        - EditText emailField
        - EditText passField
        - TextView errorText
        - ExecutorService executor

        # void onCreate(Bundle savedInstanceState)
        - void showError(String msg)
        - void navigateToRoleHome(User u)
        # void onDestroy()
    }

    class MainActivity {
        # void onCreate(Bundle savedInstanceState)
    }

    class RecipeAdapter {
        - List<Recipe> recipeList
        - OnRecipeClickListener listener
        + interface OnRecipeClickListener
        + RecipeAdapter(List<Recipe> recipeList, OnRecipeClickListener listener)
        + RecipeViewHolder onCreateViewHolder(ViewGroup parent, int viewType)
        + void onBindViewHolder(RecipeViewHolder holder, int position)
        + int getItemCount()
    }

    class RecipeViewHolder {
        + RecipeViewHolder(View itemView)
    }

    class RecipeImage {
        - String name
        - int resId
        + RecipeImage(String name, int resId)
        + String getName()
        + int getResId()
        + String toString()
    }

    class RecipeImageAdapter {
        + RecipeImageAdapter(Context context, List<RecipeImage> images)
        + View getView(int position, View convertView, ViewGroup parent)
        + View getDropDownView(int position, View convertView, ViewGroup parent)
        - View inflateRow(int position, View convertView, ViewGroup parent)
    }

    class RecipeListActivity {
        - RecyclerView recyclerView
        - TextView textViewEmpty
        - Button btnAddRecipe
        - Button btnGoToChef
        - RecipeRepository recipeRepository

        # void onCreate(Bundle savedInstanceState)
        # void onResume()
        - void updateRecipeList()
        + void onRecipeClick(Recipe recipe)
    }

    class RecordSaleActivity {
        - spinnerRecipes : Spinner
        - spinnerRating : Spinner
        - etNote : EditText
        - btnRecord : Button

        - recipeRepository : RecipeRepository
        - saleRepository : SaleRepository
        - recipes : List<Recipe>

        + onCreate(Bundle) : void
        - recordSale() : void
    }

    class SalesSummaryAtivity {
        - rvSummary : RecyclerView
        - adapter : SalesSummaryAdapter
        - saleRepository : SaleRepository

        + onCreate(Bundle) : void
        + onResume() : void
        - loadSummary() : void
    }


    class SalesSummaryAdapter {
        - static TYPE_HEADER : int
        - static TYPE_SALE : int
        - items : List<Object>

        + setData(List<Object>) : void
        + getItemViewType(int) : int
        + getItemCount() : int
        + onCreateViewHolder(ViewGroup, int) : RecyclerView.ViewHolder
        + onBindViewHolder(RecyclerView.ViewHolder, int) : void
        - getStars(int) : String
    }


    class HeaderModel {
        + recipeName: String
        + count: int
        + avgRating: double
    }

    class HeaderHolder {
        + tvName : TextView
        + tvStats : TextView
    }

    class SaleHolder {
        + tvMeta : TextView
        + tvNote : TextView
    }


    class TextAdapter{
        - localdata: List<String>
        + TextAdapter()
        + onCreateViewHolder(ViewGroup parent, int viewType): ViewHolder
        + onBindViewHolder(ViewHolder holder, int position): void
        + getItemCount(): int
    }

    class ViewRecipeActivity{
        - tvRecipeName: TextView
        - tvRecipeDescription: TextView
        - ivRecipeImage: ImageView
        - rvIngredients: RecyclerView
        - recipeId: int
        - ingredientList: List<RecipeIngredient>
        # onCreate(Bundle savedInstanceState): void
        - loadRecipeData(): void
    }

    class WaiterActivity {
        - Button btnLogout
        - Button btnChangePassword
        - String currentWaiterEmail
        - UserRepository userRepository

        # void onCreate(Bundle savedInstanceState)
        - void showChangePasswordDialog(String userEmail)
    }

    class WelcomeActivity {
        # void onCreate(Bundle savedInstanceState)
    }

    '============ relationships ============

    AdminActivity -|> AppCompatActivity
    CaptureAct -|> CaptureActivity
    
    ChefActivity -|> AppCompatActivity
    ChefActivity ..> RecipeRepository
    
    CreateRecipeActivity -|> AppCompatActivity
    CreateRecipeActivity --> IngredientDetailAdapter
    CreateRecipeActivity ..> RecipeRepository

    LoginActivity -|> AppCompatActivity
    LoginActivity ..> UserRepository
    
    RecipeListActivity -|> AppCompatActivity
    RecipeListActivity o-- RecipeAdapter
    RecipeListActivity --> IngredientDetailAdapter
    RecipeListActivity --> TextAdapter
    RecipeListActivity ..> RecipeRepository
    
    RecordSaleActivity -|> AppCompatActivity
    RecordSaleActivity --> RecipeRepository : utilise (singleton)
    RecordSaleActivity --> SaleRepository : utilise (singleton)
    RecordSaleActivity --> Recipe : lit les données
    RecordSaleActivity --> WaiterActivity : navigation Intent
    RecipeRepository --> Recipe : fournit listes

    
    SalesSummaryActivity --|> AppCompatActivity
    
    SalesSummaryActivity --> SalesSummaryAdapter : crée/associe
    SalesSummaryActivity --> SaleRepository : utilise (singleton)
    SalesSummaryActivity --> WaiterActivity : navigation Intent

    SalesSummaryAdapter ..> SaleRepository
    SalesSummaryAdapter o--> "0..*" Object : items
    SalesSummaryAdapter --> RecyclerView.ViewHolder : crée / utilise
    SalesSummaryAdapter --> Sale : affiche

    HeaderModel --* SalesSummaryAdapter : "contient"
    HeaderHolder --|> RecyclerView.ViewHolder
    SaleHolder --|> RecyclerView.ViewHolder


    RecipeAdapter -|> RecyclerView.Adapter
    RecipeAdapter o-- Recipe

    IngredientDetailAdapter -|> RecyclerView.Adapter
    IngredientDetailAdapter o-- RecipeIngredient

    TextAdapter -|> RecyclerView.Adapter
    TextAdapter o-- String

    WaiterActivity -|> AppCompatActivity
    WaiterActivity ..> UserRepository

    WelcomeActivity -|> AppCompatActivity
    MainActivity -|> AppCompatActivity

    IngredientAdapter --> RecipeIngredient
    IngredientAdapter --> ViewHolder
    ViewHolder --> TextView
}


'=============
'utility classes
'=============

package "com.example.utaste.util" {
    class Validators{
        + static String validateLoginFields(String email, String password)
        + static String validateNewUser(String email, String password)
    }
}

'=========================
'EXTRA
'=========================



@enduml